<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Favoritos | Inmobiliaria La Casona</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SweetAlert2 for beautiful modals -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/chatbot.css">
</head>

<body>

    <div class="header-band">
        ASESORAMIENTO PERSONALIZADO | FINANCIACIÓN EXCLUSIVA
    </div>

    <header class="main-header">
        <a href="index.html" class="logo">
            <i class="fa-solid fa-house-chimney"></i>
            LA CASONA
        </a>

        <div class="header-icons">
            <div class="icon-item" onclick="window.location.href='index.html'">
                <i class="fa-solid fa-arrow-left"></i>
                <span>Volver</span>
            </div>
            <div class="icon-item" style="color: var(--primary-color);">
                <span id="user-display">Maria Vargas</span>
            </div>
        </div>
    </header>

    <main class="favorites-container">
        <h1 class="section-title">Mis Favoritos</h1>

        <div id="favorites-grid" class="properties-grid">
            <!-- Cards will be injected here via JS -->
        </div>

        <div id="no-favorites" class="empty-state" style="display: none;">
            <i class="fa-regular fa-heart"></i>
            <h3>Aún no has guardado propiedades favoritas.</h3>
            <p>Explora nuestro catálogo y guarda las que más te gusten.</p>
            <a href="index.html"
                style="color: var(--primary-color); font-weight: bold; margin-top: 10px; display: inline-block;">Ver
                Propiedades</a>
        </div>
    </main>

    <footer>
        © 2024 - Inmobiliaria La Casona - Todos los derechos reservados.
    </footer>

    <script>
        const favoritesGrid = document.getElementById('favorites-grid');
        const noFavorites = document.getElementById('no-favorites');
        const userDisplay = document.getElementById('user-display');

        async function loadFavorites() {
            const session = JSON.parse(localStorage.getItem('userSession'));
            if (session) userDisplay.innerText = session.user.nombre;

            const favorites = JSON.parse(localStorage.getItem('userFavorites')) || [];

            if (favorites.length === 0) {
                favoritesGrid.style.display = 'none';
                noFavorites.style.display = 'block';
                return;
            }

            favoritesGrid.style.display = 'grid';
            noFavorites.style.display = 'none';
            favoritesGrid.innerHTML = '<p style="text-align:center; grid-column: 1/-1;">Cargando tus favoritos...</p>';

            try {
                // Fetch all property details for the IDs in favorites
                // For simplicity we fetch all and filter, or fetch one by one
                // Better approach: fetch all and filter locally for this demo
                const response = await fetch('/api/propiedades');
                const allProps = await response.json();

                const myFavorites = allProps.filter(p => favorites.includes(p.id.toString()));

                favoritesGrid.innerHTML = ''; // Clear loading

                myFavorites.forEach(prop => {
                    const card = document.createElement('div');
                    card.className = 'property-card';
                    card.onclick = () => window.location.href = `propiedad-detalle.html?id=${prop.id}`;

                    const mainImage = prop.imagenes_propiedad?.[0]?.url_imagen || 'https://via.placeholder.com/500x300';
                    const tagText = prop.tipo_operacion.toUpperCase();
                    const tagColor = prop.tipo_operacion === 'venta' ? 'var(--accent-color)' : '#17a2b8';

                    card.innerHTML = `
                        <div class="card-image">
                            <div class="card-fav" onclick="removeFavorite(event, '${prop.id}')" title="Eliminar de favoritos">
                                <i class="fa-solid fa-trash-can" style="color: #999; font-size: 14px;"></i>
                            </div>
                            <span class="card-tag" style="background: ${tagColor}">${tagText}</span>
                            <img src="${mainImage}" alt="${prop.titulo}">
                        </div>
                        <div class="card-info">
                            <h3 class="card-title">${prop.titulo}</h3>
                            <div class="card-price">${prop.moneda} ${parseFloat(prop.precio).toLocaleString()}</div>
                            <div class="card-details">
                                <span>${prop.dormitorios || 0} Dorm</span>
                                <span>${prop.banos || 0} Baños</span>
                                <span>${prop.superficie_total || 0}m²</span>
                            </div>
                        </div>
                    `;
                    favoritesGrid.appendChild(card);
                });

                if (myFavorites.length === 0) {
                    favoritesGrid.style.display = 'none';
                    noFavorites.style.display = 'block';
                }

            } catch (error) {
                console.error('Error:', error);
                favoritesGrid.innerHTML = '<p style="text-align:center; grid-column: 1/-1;">Error al cargar favoritos.</p>';
            }
        }

        function removeFavorite(event, id) {
            event.stopPropagation();
            Swal.fire({
                title: '¿Eliminar de favoritos?',
                text: "Esta acción quitará la propiedad de tu lista.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#1a2b4c',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    let favorites = JSON.parse(localStorage.getItem('userFavorites')) || [];
                    favorites = favorites.filter(favId => favId !== id.toString());
                    localStorage.setItem('userFavorites', JSON.stringify(favorites));

                    Swal.fire('¡Eliminado!', 'Quitado de tus favoritos.', 'success');
                    loadFavorites();
                }
            })
        }

        // Initialize
        loadFavorites();

    </script>
    <script src="assets/js/chatbot.js"></script>
</body>

</html>